name: Update Player Injury History

on:
  schedule:
    # Weekly during NFL season (Sep-Feb): Every Wednesday 7:00 AM UTC
    - cron: '0 7 * 9,10,11,12,1,2 3'  
    
    # Monthly during offseason (Mar-Aug): First Wednesday 7:00 AM UTC  
    - cron: '0 7 1-7 3,4,5,6,7,8 3' 

  workflow_dispatch:  

jobs:
  scrape-injury-data:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours max (250 players * ~30s each)
    
    steps:
    - name: Checkout injury scraper repo
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        # Create package.json if it doesn't exist
        if [ ! -f "package.json" ]; then
          echo "ğŸ“¦ Creating package.json..."
          npm init -y
        fi
        
        echo "ğŸ“¦ Installing dependencies..."
        npm install axios cheerio
        
    - name: Create output directory
      run: |
        echo "ğŸ“ Creating output directory..."
        mkdir -p For-AI/Injury
        
    - name: Run Fox Sports injury scraper
      env:
        NODE_ENV: production
        BATCH_SIZE: ${{ github.event.inputs.batch_size || '5' }}
      run: |
        echo "ğŸš€ Starting Fox Sports injury scraper with batch size ${BATCH_SIZE}..."
        node Scraper/injury-history-scraper.js
        echo "ğŸ“Š Injury scraping completed!"
        
    - name: Verify output file
      run: |
        if [ -f "For-AI/Injury/injury-history.json" ]; then
          echo "âœ… injury-history.json created successfully"
          echo "ğŸ“ File size: $(du -h For-AI/Injury/injury-history.json | cut -f1)"
          echo "ğŸ”¢ Player count: $(jq '.total_players' For-AI/Injury/injury-history.json)"
          echo "ğŸ“… Generated: $(jq -r '.timestamp' For-AI/Injury/injury-history.json)"
          echo "ğŸ¥ Total injuries: $(jq '[.data[] | .injuries | length] | add' For-AI/Injury/injury-history.json)"
        else
          echo "âŒ injury-history.json not found!"
          exit 1
        fi
        
    - name: Commit updated injury data to repository
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name 'NFL Injury Data Bot'
        git config --global user.email 'bot@injurydatabot.com'
        
        # Add the new data file
        git add For-AI/Injury/injury-history.json
        
        # Create/update README with injury data info
        if [ ! -f "README.md" ]; then
          echo "# Fantasy AI with NFL Player Injury Data" > README.md
        fi
        
        # Add injury data section to README
        echo "" >> README.md
        echo "## ğŸ¥ Latest NFL Injury Data" >> README.md
        echo "**Last Updated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> README.md
        echo "**Players:** $(jq '.total_players' For-AI/Injury/injury-history.json)" >> README.md
        echo "**Season:** $(jq '.current_nfl_season' For-AI/Injury/injury-history.json)" >> README.md
        echo "**Total Injuries:** $(jq '[.data[] | .injuries | length] | add' For-AI/Injury/injury-history.json)" >> README.md
        echo "**File:** \`For-AI/Injury/injury-history.json\`" >> README.md
        echo "" >> README.md
        
        # Check if anything changed
        if git diff --cached --quiet; then
          echo "ğŸ“­ No changes detected - injury data unchanged"
        else
          echo "ğŸ“ Changes detected - committing injury data update"
          git add README.md
          git commit -m "ğŸ¥ Update NFL player injury data - $(date -u '+%Y-%m-%d %H:%M UTC')"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git HEAD:main
          echo "âœ… Successfully updated injury data in repository"
        fi
        
    - name: Summary
      if: always()
      run: |
        echo "ğŸ¯ **Injury Scraping Summary**"
        if [ -f "For-AI/Injury/injury-history.json" ]; then
          echo "âœ… **Success:** $(jq '.stats.successful' For-AI/Injury/injury-history.json) players"
          echo "âŒ **Failed:** $(jq '.stats.failed' For-AI/Injury/injury-history.json) players" 
          echo "ğŸš« **Invalid:** $(jq '.stats.wrong_player' For-AI/Injury/injury-history.json) players"
          echo "ğŸ“Š **Total:** $(jq '.total_players' For-AI/Injury/injury-history.json) players in database"
          echo "ğŸ¥ **Injuries:** $(jq '[.data[] | .injuries | length] | add' For-AI/Injury/injury-history.json) total injury records"
          echo "ğŸ†• **Rookies:** $(jq '[.data[] | select(.is_likely_rookie == true)] | length' For-AI/Injury/injury-history.json) likely rookies found"
        else
          echo "âŒ **Failed:** No injury data file generated"
        fi
