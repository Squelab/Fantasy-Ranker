name: Update Player Stats

on:
  schedule:
    # Weekly during NFL season (Sep-Feb): Every Tuesday 6:00 AM UTC
    - cron: '0 6 * 9,10,11,12,1,2 2'  
    
    # Monthly during offseason (Mar-Aug): First Tuesday 6:00 AM UTC  
    - cron: '0 6 1-7 3,4,5,6,7,8 2' 
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Batch size for scraping (3=slower but safer, 5=faster)'
        required: false
        default: '5'

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours max (250 players * ~30s each)
    
    steps:
    - name: Checkout scraper repo
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        # Create package.json if it doesn't exist
        if [ ! -f "package.json" ]; then
          echo "📦 Creating package.json..."
          npm init -y
        fi
        
        echo "📦 Installing dependencies..."
        npm install axios cheerio
        
    - name: Run fantasy scraper
      env:
        NODE_ENV: production
        BATCH_SIZE: ${{ github.event.inputs.batch_size || '5' }}
      run: |
        echo "🚀 Starting FantasyPros scraper with batch size ${BATCH_SIZE}..."
        node standalone-scraper.js
        echo "📊 Scraping completed!"
        
    - name: Verify output file
      run: |
        if [ -f "For-AI/Stats/player-stats.json" ]; then
          echo "✅ player-stats.json created successfully"
          echo "📁 File size: $(du -h For-AI/Stats/player-stats.json | cut -f1)"
          echo "🔢 Player count: $(jq '.total_players' For-AI/Stats/player-stats.json)"
          echo "📅 Generated: $(jq -r '.timestamp' For-AI/Stats/player-stats.json)"
        else
          echo "❌ player-stats.json not found!"
          exit 1
        fi
        
    - name: Commit updated data to repository
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name 'Fantasy Data Bot'
        git config --global user.email 'bot@fantasydatabot.com'
        
        # Add the new data file
        git add player-data.json
        
        # Create/update README with data info
        if [ ! -f "README.md" ]; then
          echo "# Fantasy AI with Player Data" > README.md
        fi
        
        # Add data section to README
        echo "" >> README.md
        echo "## 📊 Latest Player Data" >> README.md
        echo "**Last Updated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> README.md
        echo "**Players:** $(jq '.total_players' player-data.json)" >> README.md
        echo "**Season:** $(jq '.current_nfl_season' player-data.json)" >> README.md
        echo "**File:** \`player-data.json\`" >> README.md
        echo "" >> README.md
        
        # Check if anything changed
        if git diff --cached --quiet; then
          echo "📭 No changes detected - data unchanged"
        else
          echo "📝 Changes detected - committing update"
          git add README.md
          git commit -m "📊 Update fantasy player data - $(date -u '+%Y-%m-%d %H:%M UTC')"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git HEAD:main
          echo "✅ Successfully updated player data in repository"
        fi
        
    - name: Summary
      if: always()
      run: |
        echo "🎯 **Scraping Summary**"
        if [ -f "player-data.json" ]; then
          echo "✅ **Success:** $(jq '.stats.successful' player-data.json) players"
          echo "❌ **Failed:** $(jq '.stats.failed' player-data.json) players" 
          echo "🚫 **Invalid:** $(jq '.stats.wrong_player' player-data.json) players"
          echo "📊 **Total:** $(jq '.total_players' player-data.json) players in database"
        else
          echo "❌ **Failed:** No data file generated"
        fi
